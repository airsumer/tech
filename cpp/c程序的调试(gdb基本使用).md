

# 使用gdb进行调试

过程

1. 编译时加上`-g`选项
2. 启动*gdb*时加上`-q`选项,屏蔽*gdb*的免责条款
3. 使用命令进行调试

gdb的基本命令:

| 调试指令                    | 作 用                                                                                  |
| --------------------------- | -------------------------------------------------------------------------------------- |
| (gdb) break xxx (gdb) b xxx | 在源代码指定的某一行设置断点，其中 xxx 用于指定具体打断点的位置。                      |
| clear num                   | 清除某行的断点                                                                         |
| (gdb) run (gdb) r           | 执行被调试的程序，其会自动在第一个断点处暂停执行。                                     |
| (gdb) continue (gdb) c      | 当程序在某一断点处停止运行后，使用该指令可以继续执行，直至遇到下一个断点或者程序结束。 |
| (gdb) next (gdb) n          | 令程序一行代码一行代码的执行。                                                         |
| (gdb) print xxx (gdb) p xxx | 打印指定变量的值，其中 xxx 指的就是某一变量名。                                        |
| display                     | 每次执行打印指定变量的值                                                               |
| (gdb) list (gdb) l          | 显示源程序代码的内容，包括各行代码所在的行号。                                         |
| (gdb) quit (gdb) q          | 终止调试。                                                                             |
| finish                      | 跳出函数                                                                               |


## 打断点

### break--打普通断点

### watch命令-打观察断点-监控变量值的变化

使用 GDB 调试程序的过程中，借助**观察断点**可以监控程序中某个变量或者表达式的值，只要发生改变，程序就会停止执行。

watch的语法为：`watch variable`
查看当前的观察点:`info watchpoints`

### catch-打捕捉断点

而捕捉断点的作用是，监控程序中**某一事件**的发生，例如程序发生某种异常时、某一动态库被加载时等等，一旦目标时间发生，则程序停止执行。

``` bash
(gdb) catch event
```

常见的事件有:

| event 事件                    | 含 义                                                                                                                                                                                                                      |
| ----------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| throw [exception]             | 当程序中抛出 exception 指定类型异常时，程序停止执行。如果不指定异常类型（即省略 exception），则表示只要程序发生异常，程序就停止执行。                                                                                      |
| catch [exception]             | 当程序中捕获到 exception 异常时，程序停止执行。exception 参数也可以省略，表示无论程序中捕获到哪种异常，程序都暂停执行。                                                                                                    |
| load [regexp] unload [regexp] | 其中，regexp 表示目标动态库的名称，load 命令表示当 regexp 动态库加载时程序停止执行；unload 命令表示当 regexp 动态库被卸载时，程序暂停执行。regexp 参数也可以省略，此时只要程序中某一动态库被加载或卸载，程序就会暂停执行。 |

### 条件断点

使用`if cond`,做条件判断,仅当满足一定条件时才打断点.

``` bash
(gdb) break ... if cond
```

### 删除断点

通过 `delete`命令可以删除断点。使用`delete NUM`的方式删除序号为NUM的断点

![image-20230302215526179](https://qingbin.oss-cn-chengdu.aliyuncs.com/img/2023/20230302215527.png)

## 单步调试

| 命令   | 特点                           |
| ------ | ------------------------------ |
| s      | 步入被调用函数内部             |
| n      | 执行当前行代码，不进入函数内部 |
| u      | 执行到指定行                   |
| finish | 跳出当前函数                   |


- **u命令**

``` shell
(gdb) until
(gdb) until location
```

1. 可以使 GDB 调试器快速运行完当前的循环体，并运行至循环体外停止注意，until 命令并非任何情况下都会发挥这个作用，只有当执行至循环体尾部（最后一行代码）时，until 命令才会发生此作用；反之，until 命令和 next 命令的功能一样，只是单步执行程序。
2. 通过执行 until 19 命令，GDB 调试器直接执行至指定的第 19 行。

## 变量信息查看

### 数据的查看格式

| 符号 | 说明                 |
| ---- | -------------------- |
| s    | 以字符串形式进行输出 |

#### p(print)命令

``` shell
(gdb) print num
(gdb) p num
```

num:目标变量或者表达式

#### display命令

使用 display 命令查看变量或表达式的值，每当程序暂停执行（例如单步执行）时，GDB 调试器都会自动帮我们打印出来，而 print 命令则不会。

``` shell
(gdb) display expr
(gdb) display/fmt expr
```

其中，expr 表示要查看的目标变量或表达式；参数 fmt 用于指定输出变量或表达式的格式，表 1 罗列了常用的一些 fmt 参数。

| /fmt | 功 能                                |
| ---- | ------------------------------------ |
| /x   | 以十六进制的形式打印出整数。         |
| /d   | 以有符号、十进制的形式打印出整数。   |
| /u   | 以无符号、十进制的形式打印出整数。   |
| /o   | 以八进制的形式打印出整数。           |
| /t   | 以二进制的形式打印出整数。           |
| /f   | 以浮点数的形式打印变量或表达式的值。 |
| /c   | 以字符形式打印变量或表达式的值。     |

**注意，display 命令和 /fmt 之间不要留有空格。以 /x 为例，应写为 (gdb)display/x expr**

事实上，对于使用 display 命令查看的目标变量或表达式，都会被记录在一张列表（称为自动显示列表）中。通过执行`info dispaly`命令，可以打印出这张表.



`display`变量的删除,禁用,和激活

| 功能              | 命令                      |
| ----------------- | ------------------------- |
| 删除display变量   | `undisplay num...`        |
|                   | `delete display num...`   |
| 禁用display       | ` disable display num...` |
| 激活禁用的display | `enable display num...`   |

#### p和display命令的区别

使用 1 次 print 命令只能查看 1 次某个变量或表达式的值，而同样使用 1 次 display 命令，每次程序暂停执行时都会自动打印出目标变量或表达式的值。因此，当我们想频繁查看某个变量或表达式的值从而观察它的变化情况时，使用 display 命令可以一劳永逸

Q：如何使用<>导入自己写的头文件而不是使用"",mvfst项目中使用的就是<>

通过`-I`或者cmake中的`target_include_directories()`函数就可以使用<>替代，当然，使用""也是可以的

# 使用assert宏辅助调试

程序中如果添加很多debug信息就会暴露程序的很多技术细节，此时就可以使用assert语句规避这种暴露细节的问题。

assert常常和absort()使用，即当条件不满足时就会打印调试信息。如果不需要打印调试信息，只需要在程序中定义**NDEBUG**宏就行。（宏定义要在include assert之前）。还有一种方法，就是在编译时定义宏，如`g++ assert.cpp -DNDEBUG`,-D表示添加宏
